use std::{
	collections::BTreeMap,
	sync::{Arc, LazyLock},
};

use emukc_cache::Kache;
use emukc_model::kc2::start2::ApiManifest;

use crate::{
	make_list::{CacheList, batch_check_exists},
	prelude::{CacheListMakeStrategy, CacheListMakingError},
};

static LIST: LazyLock<&[&str]> = LazyLock::new(|| {
	&[
		"album/album_main.json",
		"album/album_main.png",
		"album/album_slot2.json",
		"album/album_slot2.png",
		"album/album_slot3.json",
		"album/album_slot3.png",
		"album/album_slot4.json",
		"album/album_slot4.png",
		"arsenal/arsenal_animation.json",
		"arsenal/arsenal_animation.png",
		"arsenal/arsenal_main.json",
		"arsenal/arsenal_main.png",
		"arsenal/arsenal_skin_1.json",
		"arsenal/arsenal_skin_1.png",
		"arsenal/arsenal_skin_2.json",
		"arsenal/arsenal_skin_2.png",
		"arsenal/arsenal_skin_3.json",
		"arsenal/arsenal_skin_3.png",
		"battle/battle_airunit.json",
		"battle/battle_airunit.png",
		"battle/battle_balloon.json",
		"battle/battle_balloon.png",
		"battle/battle_cutin_anti_air.json",
		"battle/battle_cutin_anti_air.png",
		"battle/battle_cutin_damage.json",
		"battle/battle_cutin_damage.png",
		"battle/battle_cutin_gouchin.json",
		"battle/battle_cutin_gouchin.png",
		"battle/battle_jin.json",
		"battle/battle_jin.png",
		"battle/battle_jin/001_e.png",
		"battle/battle_jin/001_f.png",
		"battle/battle_jin/002_e.png",
		"battle/battle_jin/002_f.png",
		"battle/battle_jin/003_e.png",
		"battle/battle_jin/003_f.png",
		"battle/battle_jin/004_e.png",
		"battle/battle_jin/004_f.png",
		"battle/battle_jin/005_e.png",
		"battle/battle_jin/005_f.png",
		"battle/battle_jin/006_e.png",
		"battle/battle_jin/006_f.png",
		"battle/battle_jin/011_e.png",
		"battle/battle_jin/011_f.png",
		"battle/battle_jin/012_e.png",
		"battle/battle_jin/012_f.png",
		"battle/battle_jin/013_e.png",
		"battle/battle_jin/013_f.png",
		"battle/battle_jin/014_e.png",
		"battle/battle_jin/014_f.png",
		"battle/battle_main.json",
		"battle/battle_main.png",
		"battle/battle_main2.json",
		"battle/battle_main2.png",
		"battle/battle_night.json",
		"battle/battle_night.png",
		"battle/battle_telop/mes2_e_hbg.png",
		"battle/battle_telop/mes2_e_ybg.png",
		"battle/battle_telop/mes2_f_hbg.png",
		"battle/battle_telop/mes2_f_ybg.png",
		"battle/battle_telop/mes_bg_e.png",
		"battle/battle_telop/mes_bg_f.png",
		"battle/battle_telop/mes_e_hbg.png",
		"battle/battle_telop/mes_e_hbg3.png",
		"battle/battle_telop/mes_e_ybg.png",
		"battle/battle_telop/mes_f_hbg.png",
		"battle/battle_telop/mes_f_hbg3.png",
		"battle/battle_telop/mes_f_ybg.png",
		"battle/battle_telop/mes_ybg3_e.png",
		"battle/battle_telop/mes_ybg3_f.png",
		"battle/battle_telop/mes_ybg4_e.png",
		"battle/battle_telop/mes_ybg4_f.png",
		"battle/battle_telop/mes_ybg6_e.png",
		"battle/battle_telop/mes_ybg6_f.png",
		"battle/battle_telop/txt_start.png",
		"battle/battle_zrk.json",
		"battle/battle_zrk.png",
		"battle_result/battle_result_event_base.json",
		"battle_result/battle_result_event_base.png",
		"battle_result/battle_result_event_e1_zuiutyyatabjupmz.json",
		"battle_result/battle_result_event_e1_zuiutyyatabjupmz.png",
		"battle_result/battle_result_event_e2_rpsayxjjcuzguzyh.json",
		"battle_result/battle_result_event_e2_rpsayxjjcuzguzyh.png",
		"battle_result/battle_result_event_e3_hsnyanyunigysrws.json",
		"battle_result/battle_result_event_e3_hsnyanyunigysrws.png",
		"battle_result/battle_result_event_e4_ssdyxizyefifbyge.json",
		"battle_result/battle_result_event_e4_ssdyxizyefifbyge.png",
		"battle_result/battle_result_event_e5_ysezbjxwczbkwwtj.json",
		"battle_result/battle_result_event_e5_ysezbjxwczbkwwtj.png",
		"battle_result/battle_result_event_e6_bazmapzjpuifeiii.json",
		"battle_result/battle_result_event_e6_bazmapzjpuifeiii.png",
		"battle_result/battle_result_event_e7_hpzctrnpnrkdwmmn.json",
		"battle_result/battle_result_event_e7_hpzctrnpnrkdwmmn.png",
		"battle_result/battle_result_event_ed1_snhtiadymrkricmu.json",
		"battle_result/battle_result_event_ed1_snhtiadymrkricmu.png",
		"battle_result/battle_result_event_ed2_pkbcmsdahauxphgc.json",
		"battle_result/battle_result_event_ed2_pkbcmsdahauxphgc.png",
		"battle_result/battle_result_main.json",
		"battle_result/battle_result_main.png",
		"battle_result/battle_result_sanma_fes.json",
		"battle_result/battle_result_sanma_fes.png",
		"common/bg/011.png",
		"common/bg/012.png",
		"common/bg/013.png",
		"common/bg/014.png",
		"common/bg/015.png",
		"common/bg/016.png",
		"common/bg/023.png",
		"common/bg/031.png",
		"common/bg/g1.png",
		"common/bg/g2.png",
		"common/bg_map/bg_h.png",
		"common/bg_map/bg_y.png",
		"common/common_animation.json",
		"common/common_animation.png",
		"common/common_area_icon.json",
		"common/common_area_icon.png",
		"common/common_event.json",
		"common/common_event.png",
		"common/common_expedition.json",
		"common/common_expedition.png",
		"common/common_explosion.json",
		"common/common_explosion.png",
		"common/common_icon_weapon.json",
		"common/common_icon_weapon.png",
		"common/common_itemicons.json",
		"common/common_itemicons.png",
		"common/common_main.json",
		"common/common_main.png",
		"common/common_misc.json",
		"common/common_misc.png",
		"common/common_reward_count.json",
		"common/common_reward_count.png",
		"common/common_selectable_reward.json",
		"common/common_selectable_reward.png",
		"common/common_senka.json",
		"common/common_senka.png",
		"common/common_shogo.json",
		"common/common_shogo.png",
		"common/common_shutter.json",
		"common/common_shutter.png",
		"common/common_sort.json",
		"common/common_sort.png",
		"common/common_stars.json",
		"common/common_stars.png",
		"common/error.png",
		"common/focus_mask3.png",
		"common/hpgauge/hp_gauge_mask.png",
		"common/hpgauge/hp_s_bg2.png",
		"common/hpgauge/hp_s_red_light.png",
		"common/ship_bg/card/c1.png",
		"common/ship_bg/card/c2.png",
		"common/ship_bg/card/c3.png",
		"common/ship_bg/card/r1.png",
		"common/ship_bg/card/r2.png",
		"common/ship_bg/card/sr1.png",
		"common/ship_bg/card/sr2.png",
		"common/ship_bg/card/sr3.png",
		"common/ship_bg/screen/c1.png",
		"common/ship_bg/screen/c2.png",
		"common/ship_bg/screen/c3.png",
		"common/ship_bg/screen/item_c1.png",
		"common/ship_bg/screen/item_r1.png",
		"common/ship_bg/screen/r1.png",
		"common/ship_bg/screen/r2.png",
		"common/ship_bg/screen/sr1.png",
		"common/ship_bg/screen/sr2.png",
		"common/ship_bg/screen/sr3.png",
		"common/system_bg5.png",
		"duty/duty_main.json",
		"duty/duty_main.png",
		"duty/fairy/1.png",
		"duty/fairy/2.png",
		"duty/poster_girl/1.png",
		"duty/poster_girl/2.png",
		"duty/poster_girl/gyudon1.png",
		"duty/poster_girl/gyudon2.png",
		"duty/poster_girl/newyear1.png",
		"duty/poster_girl/newyear2.png",
		"duty/poster_girl/sanma1.png",
		"duty/poster_girl/sanma2.png",
		"duty/poster_girl/summer1.png",
		"duty/poster_girl/summer2.png",
		"duty/poster_girl/tsuyu1.png",
		"duty/poster_girl/tsuyu2.png",
		"duty/poster_girl/xmas1.png",
		"duty/poster_girl/xmas2.png",
		"interior/interior_parts.json",
		"interior/interior_parts.png",
		"item/akashi/1.png",
		"item/akashi/2.png",
		"item/akashi/nw1.png",
		"item/akashi/nw2.png",
		"item/akashi/smm1.png",
		"item/akashi/smm2.png",
		"item/akashi/xmas1.png",
		"item/akashi/xmas2.png",
		"item/fairy/1.png",
		"item/fairy/2.png",
		"item/item_common.json",
		"item/item_common.png",
		"item/item_fshop.json",
		"item/item_fshop.png",
		"item/item_ilist.json",
		"item/item_ilist.png",
		"item/item_ilist_hishimochi.json",
		"item/item_ilist_hishimochi.png",
		"item/item_ilist_iwashi.json",
		"item/item_ilist_iwashi.png",
		"item/item_ilist_medal.json",
		"item/item_ilist_medal.png",
		"item/item_ilist_medal_kou.json",
		"item/item_ilist_medal_kou.png",
		"item/item_ilist_presentbox.json",
		"item/item_ilist_presentbox.png",
		"item/item_ilist_pumpkin.json",
		"item/item_ilist_pumpkin.png",
		"item/item_ilist_sanma.json",
		"item/item_ilist_sanma.png",
		"item/item_ilist_setsubun.json",
		"item/item_ilist_setsubun.png",
		"item/item_ilist_teruterubozu.json",
		"item/item_ilist_teruterubozu.png",
		"item/item_ishop.json",
		"item/item_ishop.png",
		"item/item_menu_1.json",
		"item/item_menu_1.png",
		"item/item_menu_2.json",
		"item/item_menu_2.png",
		"item/item_menu_3.json",
		"item/item_menu_3.png",
		"item/item_mini.json",
		"item/item_mini.png",
		"item/item_payitemicon.json",
		"item/item_payitemicon.png",
		"jukebox/jukebox_common.json",
		"jukebox/jukebox_common.png",
		"map/map_anchorage_repair.json",
		"map/map_anchorage_repair.png",
		"map/map_cell_event.json",
		"map/map_cell_event.png",
		"map/map_compass.json",
		"map/map_compass.png",
		"map/map_decision.json",
		"map/map_decision.png",
		"map/map_enemy_bannerframes.json",
		"map/map_enemy_bannerframes.png",
		"map/map_event_anime.json",
		"map/map_event_anime.png",
		"map/map_event_anime_483.json",
		"map/map_event_anime_483.png",
		"map/map_fairy.json",
		"map/map_fairy.png",
		"map/map_flagship_damage.json",
		"map/map_flagship_damage.png",
		"map/map_main.json",
		"map/map_main.png",
		"map/map_telop.json",
		"map/map_telop.png",
		"minigame/minigame_gotsheep.json",
		"minigame/minigame_gotsheep.png",
		"organize/organize_filter.json",
		"organize/organize_filter.png",
		"organize/organize_hokyu_dialog_default.json",
		"organize/organize_hokyu_dialog_default.png",
		"organize/organize_hokyu_dialog_summer.json",
		"organize/organize_hokyu_dialog_summer.png",
		"organize/organize_hokyu_dialog_xmas.json",
		"organize/organize_hokyu_dialog_xmas.png",
		"organize/organize_main.json",
		"organize/organize_main.png",
		"organize/organize_mamiya_animation_common.json",
		"organize/organize_mamiya_animation_common.png",
		"organize/organize_mamiya_animation_default.json",
		"organize/organize_mamiya_animation_default.png",
		"organize/organize_mamiya_animation_summer.json",
		"organize/organize_mamiya_animation_summer.png",
		"organize/organize_mamiya_animation_xmas.json",
		"organize/organize_mamiya_animation_xmas.png",
		"organize/organize_rengo.json",
		"organize/organize_rengo.png",
		"organize/organize_ship.json",
		"organize/organize_ship.png",
		"port/port_friendly_request.json",
		"port/port_friendly_request.png",
		"port/port_main.json",
		"port/port_main.png",
		"port/port_option.json",
		"port/port_option.png",
		"port/port_ringmenu.json",
		"port/port_ringmenu.png",
		"port/port_ships.json",
		"port/port_ships.png",
		"port/port_sidemenu.json",
		"port/port_sidemenu.png",
		"port/port_skin_1.json",
		"port/port_skin_1.png",
		"port/port_skin_2.json",
		"port/port_skin_2.png",
		"port/port_skin_3.json",
		"port/port_skin_3.png",
		"port/port_skin_3k.json",
		"port/port_skin_3k.png",
		"port/port_skin_3k_huki.json",
		"port/port_skin_3k_huki.png",
		"port/port_skin_circle_2.json",
		"port/port_skin_circle_2.png",
		"port/port_tutorial.json",
		"port/port_tutorial.png",
		"prac/prac_main.json",
		"prac/prac_main.png",
		"record/record_airbase_maint.json",
		"record/record_airbase_maint.png",
		"record/record_menu.json",
		"record/record_menu.png",
		"record/record_mini.json",
		"record/record_mini.png",
		"record/record_parts.json",
		"record/record_parts.png",
		"remodel/6slot_huki1_c.png",
		"remodel/6slot_huki1_l.png",
		"remodel/6slot_huki1_r.png",
		"remodel/6slot_huki2.png",
		"remodel/bg/vignette_frame.png",
		"remodel/remodel_animation.json",
		"remodel/remodel_animation.png",
		"remodel/remodel_gradeup.json",
		"remodel/remodel_gradeup.png",
		"remodel/remodel_main.json",
		"remodel/remodel_main.png",
		"remodel/remodel_powerup.json",
		"remodel/remodel_powerup.png",
		"remodel/remodel_preset.json",
		"remodel/remodel_preset.png",
		"remodel/remodel_preset_slot_text.json",
		"remodel/remodel_preset_slot_text.png",
		"remodel/remodel_pumpkin.json",
		"remodel/remodel_pumpkin.png",
		"repair/repair_main.json",
		"repair/repair_main.png",
		"repair/repair_sort.json",
		"repair/repair_sort.png",
		"revamp/revamp_box.json",
		"revamp/revamp_box.png",
		"revamp/revamp_list.json",
		"revamp/revamp_list.png",
		"revamp/revamp_main.json",
		"revamp/revamp_main.png",
		"revamp/revamp_pager.json",
		"revamp/revamp_pager.png",
		"revamp/revamp_revamp.json",
		"revamp/revamp_revamp.png",
		"sally/alert/alert_1.png",
		"sally/alert/alert_10.png",
		"sally/alert/alert_11.png",
		"sally/alert/alert_12.png",
		"sally/alert/alert_13.png",
		"sally/alert/alert_14.png",
		"sally/alert/alert_15.png",
		"sally/alert/alert_16.png",
		"sally/alert/alert_17.png",
		"sally/alert/alert_18.png",
		"sally/alert/alert_19.png",
		"sally/alert/alert_2.png",
		"sally/alert/alert_20.png",
		"sally/alert/alert_21.png",
		"sally/alert/alert_22.png",
		"sally/alert/alert_23.png",
		"sally/alert/alert_24.png",
		"sally/alert/alert_25.png",
		"sally/alert/alert_26.png",
		"sally/alert/alert_27.png",
		"sally/alert/alert_28.png",
		"sally/alert/alert_29.png",
		"sally/alert/alert_3.png",
		"sally/alert/alert_30.png",
		"sally/alert/alert_31.png",
		"sally/alert/alert_32.png",
		"sally/alert/alert_33.png",
		"sally/alert/alert_34.png",
		"sally/alert/alert_36.png",
		"sally/alert/alert_37.png",
		"sally/alert/alert_38.png",
		"sally/alert/alert_39.png",
		"sally/alert/alert_4.png",
		"sally/alert/alert_40.png",
		"sally/alert/alert_41.png",
		"sally/alert/alert_42.png",
		"sally/alert/alert_43.png",
		"sally/alert/alert_44.png",
		"sally/alert/alert_45.png",
		"sally/alert/alert_46.png",
		"sally/alert/alert_47.png",
		"sally/alert/alert_48.png",
		"sally/alert/alert_49.png",
		"sally/alert/alert_5.png",
		"sally/alert/alert_50.png",
		"sally/alert/alert_51.png",
		"sally/alert/alert_52.png",
		"sally/alert/alert_53.png",
		"sally/alert/alert_54.png",
		"sally/alert/alert_6.png",
		"sally/alert/alert_7.png",
		"sally/alert/alert_8.png",
		"sally/alert/alert_9.png",
		"sally/event_maesetsu/300_c5526.png",
		"sally/sally_airbase_maint.json",
		"sally/sally_airbase_maint.png",
		"sally/sally_airunit.json",
		"sally/sally_airunit.png",
		"sally/sally_common.json",
		"sally/sally_common.png",
		"sally/sally_event.json",
		"sally/sally_event.png",
		"sally/sally_event_s.json",
		"sally/sally_event_s.png",
		"sally/sally_event_second.json",
		"sally/sally_event_second.png",
		"sally/sally_expedition.json",
		"sally/sally_expedition.png",
		"sally/sally_expedition_detail.json",
		"sally/sally_expedition_detail.png",
		"sally/sally_jin.json",
		"sally/sally_jin.png",
		"sally/sally_map_parts.json",
		"sally/sally_map_parts.png",
		"sally/sally_practice.json",
		"sally/sally_practice.png",
		"sally/sally_sortie.json",
		"sally/sally_sortie.png",
		"sally/sally_strategymap.json",
		"sally/sally_strategymap.png",
		"sally/sally_strategymap_petal.json",
		"sally/sally_strategymap_petal.png",
		"sally/sally_strategymap_s.json",
		"sally/sally_strategymap_s.png",
		"sally/sally_strategymap_second.json",
		"sally/sally_strategymap_second.png",
		"sally/sally_top.json",
		"sally/sally_top.png",
		"supply/supply_main.json",
		"supply/supply_main.png",
		"title/01.png",
		"title/02.png",
		"title/03.png",
		"title/04.png",
		"title/05.png",
		"title/06.png",
		"title/title2.png",
		"title/title_main.json",
		"title/title_main.png",
		"tutorial/bg.png",
		"tutorial/chara/c009_bg.png",
		"tutorial/chara/c009_full.png",
		"tutorial/chara/c009_txt.png",
		"tutorial/chara/c033_bg.png",
		"tutorial/chara/c033_full.png",
		"tutorial/chara/c033_txt.png",
		"tutorial/chara/c037_bg.png",
		"tutorial/chara/c037_full.png",
		"tutorial/chara/c037_txt.png",
		"tutorial/chara/c046_bg.png",
		"tutorial/chara/c046_full.png",
		"tutorial/chara/c046_txt.png",
		"tutorial/chara/c094_bg.png",
		"tutorial/chara/c094_full.png",
		"tutorial/chara/c094_txt.png",
		"tutorial/crumb_bg.png",
		"tutorial/message_box.png",
		"tutorial/title_bg.png",
		"tutorial/tutorial_main.json",
		"tutorial/tutorial_main.png",
		"wedding/wedding_marriage.json",
		"wedding/wedding_marriage.png",
		"wedding/wedding_marriage_bg.json",
		"wedding/wedding_marriage_bg.png",
	]
});

static FRIENDLY_SHIPS: LazyLock<&[&str]> = LazyLock::new(|| {
	&[
		"ff_chara_118.png",
		"ff_chara_119.png",
		"ff_chara_142_dress.png",
		"ff_chara_142.png",
		"ff_chara_192.png",
		"ff_chara_193.png",
		"ff_chara_200.png",
		"ff_chara_264.png",
		"ff_chara_363.png",
		"ff_chara_397.png",
		"ff_chara_411.png",
		"ff_chara_412.png",
		"ff_chara_439.png",
		"ff_chara_440.png",
		"ff_chara_464.png",
		"ff_chara_487.png",
		"ff_chara_520.png",
		"ff_chara_541.png",
		"ff_chara_547.png",
		"ff_chara_553.png",
		"ff_chara_557.png",
		"ff_chara_591.png",
		"ff_chara_626.png",
		"ff_chara_630_dress.png",
		"ff_chara_630.png",
		"ff_chara_631.png",
		"ff_chara_632.png",
		"ff_chara_642.png",
		"ff_chara_665_dress.png",
		"ff_chara_668.png",
		"ff_chara_699.png",
		"ff_chara_725.png",
		"ff_chara_726.png",
		"ff_chara_734.png",
		"ff_chara_906.png",
		"ff_chara_916_dress.png",
		"ff_chara_948.png",
		"ff_chara_949_dress.png",
		"ff_chara_954.png",
		"ff_chara_964.png",
		"ff_chara_969.png",
		"ff_chara_986.png",
	]
});

pub(super) async fn make(
	mst: &ApiManifest,
	cache: &Kache,
	versions: &BTreeMap<String, String>,
	strategy: CacheListMakeStrategy,
	list: &mut CacheList,
) -> Result<(), CacheListMakingError> {
	for p in LIST.iter() {
		let category = p.split('/').next().unwrap();
		let version = versions.get(category);

		list.add(format!("kcs2/img/{}", p), version);
	}

	match strategy {
		CacheListMakeStrategy::Default | CacheListMakeStrategy::Minimal => {
			let v = versions.get("port");
			for p in FRIENDLY_SHIPS.iter() {
				list.add(format!("kcs2/img/port/friendly_ship/{}", p), v);
			}
		}
		CacheListMakeStrategy::Greedy(concurrency) => {
			make_greedy(mst, cache, versions, concurrency, list).await?;
		}
	}
	// make_greedy(mst, cache, versions, 16, list).await?;

	Ok(())
}

#[allow(unused)]
async fn make_greedy(
	mst: &ApiManifest,
	cache: &Kache,
	versions: &BTreeMap<String, String>,
	concurrent: usize,
	list: &mut CacheList,
) -> Result<(), CacheListMakingError> {
	let v = versions.get("port").map(std::string::ToString::to_string).unwrap_or_default();
	let checks: Vec<(String, String)> = mst
		.friend_ships()
		.iter()
		.flat_map(|s| {
			vec![
				(format!("kcs2/img/port/friendly_ship/ff_chara_{}.png", s.api_id), v.clone()),
				(format!("kcs2/img/port/friendly_ship/ff_chara_{}_dress.png", s.api_id), v.clone()),
			]
		})
		.collect();

	let c = Arc::new(cache.clone());
	let check_result = batch_check_exists(c, checks, concurrent).await?;

	for ((p, _), exists) in check_result {
		if exists {
			println!("{}", p);
			list.add_unversioned(p);
		}
	}
	Ok(())
}
